
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TiketKita | Login</title>
  
  <!-- Font & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    /* Reset & Base */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #2563EB;
      --primary-dark: #1D4ED8;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-600: #4B5563;
      --gray-800: #1F2937;
      --success: #10B981;
      --error: #EF4444;
      --info: #3B82F6;
      --radius: 8px;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: #f8fafc;
      color: var(--gray-800);
      min-height: 100vh;
      display: flex;
      align-items: center;
      padding: 20px;
    }
    
    /* Container */
    .container {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    
    /* Header */
    .header {
      padding: 32px 32px 24px;
      text-align: center;
      border-bottom: 1px solid var(--gray-100);
    }
    
    .logo {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }
    
    .logo i {
      color: white;
      font-size: 1.2rem;
    }
    
    .header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .header p {
      color: var(--gray-600);
      font-size: 0.875rem;
    }
    
    /* Form */
    .form {
      padding: 32px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .input-wrapper {
      position: relative;
    }
    
    .input-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray-600);
      width: 20px;
      text-align: center;
    }
    
    .input {
      width: 100%;
      padding: 12px 12px 12px 40px;
      border: 1.5px solid var(--gray-200);
      border-radius: var(--radius);
      font-size: 0.9375rem;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
      background: white;
    }
    
    .input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .toggle-password {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--gray-600);
      cursor: pointer;
      padding: 4px;
    }
    
    /* Button */
    .btn {
      width: 100%;
      padding: 12px;
      border-radius: var(--radius);
      font-size: 0.9375rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    .btn-google {
      background: white;
      color: var(--gray-800);
      border: 1.5px solid var(--gray-200);
      margin-bottom: 24px;
    }
    
    .btn-google:hover {
      border-color: var(--gray-300);
      background: var(--gray-50);
    }
    
    .btn-google.loading {
      pointer-events: none;
      opacity: 0.7;
    }
    
    /* Divider */
    .divider {
      display: flex;
      align-items: center;
      margin: 24px 0;
      color: var(--gray-600);
      font-size: 0.8125rem;
    }
    
    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--gray-200);
    }
    
    .divider span {
      padding: 0 16px;
    }
    
    /* Options */
    .form-options {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 20px 0;
    }
    
    .remember {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .remember input {
      width: 16px;
      height: 16px;
      accent-color: var(--primary);
    }
    
    .remember label {
      font-size: 0.8125rem;
      color: var(--gray-600);
      cursor: pointer;
    }
    
    .forgot-link {
      color: var(--primary);
      font-size: 0.8125rem;
      text-decoration: none;
      font-weight: 500;
    }
    
    .forgot-link:hover {
      text-decoration: underline;
    }
    
    /* Footer */
    .footer {
      padding: 24px 32px;
      border-top: 1px solid var(--gray-100);
      text-align: center;
      font-size: 0.8125rem;
      color: var(--gray-600);
    }
    
    .footer a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      margin-left: 4px;
    }
    
    /* Loading */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      z-index: 1000;
    }
    
    .modal.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      width: 100%;
      max-width: 380px;
      text-align: center;
      transform: translateY(20px);
      transition: transform 0.3s;
    }
    
    .modal.active .modal-content {
      transform: translateY(0);
    }
    
    .modal-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 1.2rem;
    }
    
    .modal-icon.success { background: linear-gradient(135deg, var(--success), #34D399); color: white; }
    .modal-icon.error { background: linear-gradient(135deg, var(--error), #F87171); color: white; }
    .modal-icon.info { background: linear-gradient(135deg, var(--info), #60A5FA); color: white; }

    .modal-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--gray-800);
    }
    
    .modal-message {
      color: var(--gray-600);
      font-size: 0.875rem;
      line-height: 1.5;
      margin-bottom: 24px;
    }
    
    .modal-btn {
      padding: 10px 24px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .modal-btn:hover {
      background: var(--primary-dark);
    }

    /* Popup Instructions - TAMBAHAN BARU */
    .popup-instructions {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      z-index: 1002;
      max-width: 350px;
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s ease;
      pointer-events: none;
    }

    .popup-instructions.active {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }

    .instructions-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--gray-100);
    }

    .instructions-header h3 {
      font-size: 1rem;
      color: var(--gray-800);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .instructions-header i {
      color: var(--info);
    }

    .instructions-close {
      background: none;
      border: none;
      font-size: 1.2rem;
      color: var(--gray-600);
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .instructions-body {
      padding: 20px;
    }

    .instructions-body p {
      font-size: 0.875rem;
      color: var(--gray-600);
      margin-bottom: 12px;
    }

    .instructions-body ol {
      font-size: 0.8125rem;
      color: var(--gray-600);
      padding-left: 20px;
    }

    .instructions-body li {
      margin-bottom: 8px;
    }
    
    /* Redirect Indicator */
    .redirecting {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      padding: 8px 16px;
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-weight: 500;
      display: none;
      align-items: center;
      gap: 8px;
      z-index: 1001;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .redirecting.active {
      display: flex;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .loading-logo {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
    }
    
    .loading-logo i {
      color: white;
      font-size: 1.5rem;
    }
    
    .loading-text {
      font-size: 1rem;
      color: var(--gray-600);
      margin-bottom: 24px;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--gray-200);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    /* Google Results Popup - BARU */
    .google-results-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      z-index: 1003;
      display: none;
      overflow: hidden;
    }

    .google-results-popup.active {
      display: block;
      animation: popupOpen 0.3s ease;
    }

    .google-results-header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .google-results-title {
      font-size: 1.125rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .google-results-close {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
    }

    .google-results-close:hover {
      background: rgba(255,255,255,0.3);
    }

    .google-results-content {
      padding: 20px;
      max-height: calc(80vh - 60px);
      overflow-y: auto;
    }

    .google-results-links {
      list-style: none;
    }

    .google-results-links li {
      margin-bottom: 12px;
      padding: 12px;
      background: var(--gray-50);
      border-radius: var(--radius);
      transition: all 0.2s;
    }

    .google-results-links li:hover {
      background: var(--gray-100);
      transform: translateX(4px);
    }

    .google-results-links a {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--gray-800);
      text-decoration: none;
      font-size: 0.9375rem;
      font-weight: 500;
    }

    .google-results-links i {
      color: var(--primary);
      width: 20px;
      text-align: center;
    }

    .google-results-links .url {
      color: var(--gray-600);
      font-size: 0.75rem;
      margin-top: 4px;
      font-weight: 400;
    }

    .google-results-links .description {
      color: var(--gray-600);
      font-size: 0.8125rem;
      margin-top: 4px;
      line-height: 1.4;
    }

    .google-results-links .tags {
      display: flex;
      gap: 6px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .google-results-links .tag {
      background: var(--primary);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.6875rem;
    }

    .google-results-links .tag.google {
      background: #4285F4;
    }

    .google-results-links .tag.email {
      background: #34A853;
    }

    .google-results-links .tag.verified {
      background: #10B981;
    }

    .google-results-links .tag.unverified {
      background: #EF4444;
    }

    @keyframes popupOpen {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }

    /* Overlay */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1002;
      display: none;
    }

    .overlay.active {
      display: block;
    }

    /* Mobile */
    @media (max-width: 480px) {
      .container { border-radius: 12px; }
      .header, .form { padding: 24px; }
      .footer { padding: 20px 24px; }
      .header h1 { font-size: 1.25rem; }
      .redirecting { top: 10px; right: 10px; left: 10px; justify-content: center; }
      .popup-instructions {
        top: auto;
        bottom: 20px;
        left: 20px;
        right: 20px;
        max-width: none;
      }
      .google-results-popup {
        width: 95%;
        max-width: none;
      }
    }
    
    @media (max-width: 360px) {
      .header, .form { padding: 20px; }
      .btn { padding: 10px; }
      .form-options { flex-direction: column; gap: 12px; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loading-screen">
    <div class="loading-logo">
      <i class="fas fa-ticket-alt"></i>
    </div>
    <p class="loading-text">Memeriksa status login...</p>
    <div class="loading-spinner"></div>
  </div>

  <!-- Redirect Indicator -->
  <div class="redirecting" id="redirect-indicator">
    <i class="fas fa-spinner fa-spin"></i>
    Mengarahkan ke Dashboard...
  </div>

  <!-- Overlay -->
  <div class="overlay" id="overlay"></div>

  <!-- Google Results Popup -->
  <div class="google-results-popup" id="google-results-popup">
    <div class="google-results-header">
      <div class="google-results-title">
        <i class="fas fa-google"></i>
        Hasil Login Google
      </div>
      <button class="google-results-close" onclick="closeGoogleResults()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="google-results-content" id="google-results-content">
      <!-- Konten akan dimuat secara dinamis -->
    </div>
  </div>

  <!-- Main Container -->
  <div class="container" id="login-container" style="display: none;">
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <i class="fas fa-ticket-alt"></i>
      </div>
      <h1>Selamat Datang</h1>
      <p>Masuk untuk melanjutkan ke TiketKita</p>
    </div>
    
    <!-- Form -->
    <div class="form">
      <!-- Google Button -->
      <button type="button" class="btn btn-google" id="google-btn">
        <svg width="18" height="18" viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        <span id="google-btn-text">Masuk dengan Google</span>
        <span id="google-btn-loading" class="loading" style="display:none"></span>
      </button>
      
      <!-- Divider -->
      <div class="divider">
        <span>atau dengan email</span>
      </div>
      
      <!-- Login Form -->
      <form id="login-form">
        <div class="form-group">
          <div class="input-wrapper">
            <div class="input-icon">
              <i class="fas fa-envelope"></i>
            </div>
            <input type="email" 
                   class="input" 
                   id="email" 
                   placeholder="Email" 
                   required 
                   autocomplete="email">
          </div>
        </div>
        
        <div class="form-group">
          <div class="input-wrapper">
            <div class="input-icon">
              <i class="fas fa-lock"></i>
            </div>
            <input type="password" 
                   class="input" 
                   id="password" 
                   placeholder="Kata sandi (kosongkan untuk generate random)" 
                   autocomplete="current-password">
            <button type="button" class="toggle-password" onclick="togglePassword()">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </div>
        
        <!-- Options -->
        <div class="form-options">
          <div class="remember">
            <input type="checkbox" id="remember" name="remember" checked>
            <label for="remember">Ingat saya</label>
          </div>
          <a href="#" class="forgot-link" onclick="openForgotModal(event)">Lupa password?</a>
        </div>
        
        <!-- Submit Button -->
        <button type="submit" class="btn btn-primary" id="submit-btn">
          <span id="btn-text">Masuk</span>
          <span id="btn-loading" class="loading" style="display:none"></span>
        </button>
      </form>
    </div>
    
    <!-- Footer -->
    <div class="footer">
      Belum punya akun?
      <a href="daftar.html">Daftar sekarang</a>
    </div>
  </div>
  
  <!-- Forgot Password Modal -->
  <div class="modal" id="forgot-modal">
    <div class="modal-content">
      <div class="modal-icon success">
        <i class="fas fa-key"></i>
      </div>
      <h3 class="modal-title">Reset Password</h3>
      <p class="modal-message">Masukkan email Anda untuk menerima link reset password</p>
      
      <input type="email" 
             id="forgot-email" 
             class="input" 
             placeholder="Email Anda"
             style="margin-bottom: 20px;">
      
      <button class="modal-btn" onclick="handlePasswordReset()">Kirim Link</button>
      <button class="modal-btn" onclick="closeForgotModal()" style="margin-top: 10px; background: var(--gray-200); color: var(--gray-800);">
        Batal
      </button>
    </div>
  </div>

  <!-- Main Modal -->
  <div class="modal" id="main-modal">
    <div class="modal-content">
      <div class="modal-icon success" id="modal-icon">
        <i id="modal-icon-symbol"></i>
      </div>
      <h3 class="modal-title" id="modal-title"></h3>
      <p class="modal-message" id="modal-message"></p>
      <button class="modal-btn" onclick="closeModal()">Mengerti</button>
    </div>
  </div>

  <!-- Popup Instructions Element (Dibuat oleh JS) -->

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { 
      getAuth, 
      signInWithEmailAndPassword, 
      sendPasswordResetEmail, 
      GoogleAuthProvider, 
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult,
      setPersistence, 
      browserSessionPersistence, 
      browserLocalPersistence, 
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      updatePassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    
    import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD_-DI0MQIug3J8vciKcaFZ-knyYZC67K8",
      authDomain: "sosmed-7d6ee.firebaseapp.com",
      databaseURL: "https://sosmed-7d6ee-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "sosmed-7d6ee",
      storageBucket: "sosmed-7d6ee.appspot.com",
      messagingSenderId: "807759832196",
      appId: "1:807759832196:web:d176775e2f51f1e1918ed1",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);
    const provider = new GoogleAuthProvider();

    // Error messages
    const errors = {
      'auth/invalid-email': 'Email tidak valid',
      'auth/user-not-found': 'Akun tidak ditemukan',
      'auth/wrong-password': 'Password salah',
      'auth/too-many-requests': 'Terlalu banyak percobaan. Coba lagi nanti.',
      'auth/popup-closed-by-user': 'Popup login ditutup sebelum selesai.',
      'auth/popup-blocked': 'Popup diblokir. Silakan ikuti instruksi yang diberikan.',
      'auth/cancelled-popup-request': 'Login dibatalkan.',
      'default': 'Terjadi kesalahan. Silakan coba lagi.'
    };

    // DOM Elements
    const loadingScreen = document.getElementById('loading-screen');
    const loginContainer = document.getElementById('login-container');
    const form = document.getElementById('login-form');
    const modal = document.getElementById('main-modal');
    const forgotModal = document.getElementById('forgot-modal');
    const redirectIndicator = document.getElementById('redirect-indicator');
    const googleBtn = document.getElementById('google-btn');
    const googleBtnText = document.getElementById('google-btn-text');
    const googleBtnLoading = document.getElementById('google-btn-loading');
    const googleResultsPopup = document.getElementById('google-results-popup');
    const googleResultsContent = document.getElementById('google-results-content');
    const overlay = document.getElementById('overlay');

    // Show redirect indicator
    function showRedirectIndicator() {
      redirectIndicator.classList.add('active');
    }

    // Hide redirect indicator
    function hideRedirectIndicator() {
      redirectIndicator.classList.remove('active');
    }

    // Toggle password
    window.togglePassword = () => {
      const input = document.getElementById('password');
      const icon = document.querySelector('.toggle-password i');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
      } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
      }
    };

    // Modal functions
    function showModal(type, title, message, autoClose = true) {
      const icon = document.getElementById('modal-icon');
      const iconSymbol = document.getElementById('modal-icon-symbol');
      const modalTitle = document.getElementById('modal-title');
      const modalMessage = document.getElementById('modal-message');
      
      if (type === 'success') {
        icon.className = 'modal-icon success';
        iconSymbol.className = 'fas fa-check';
      } else if (type === 'error') {
        icon.className = 'modal-icon error';
        iconSymbol.className = 'fas fa-exclamation';
      } else { // info
        icon.className = 'modal-icon info';
        iconSymbol.className = 'fas fa-info-circle';
      }
      
      modalTitle.textContent = title;
      modalMessage.textContent = message;
      modal.classList.add('active');
      
      // Auto close success
      if (autoClose && type === 'success') {
        setTimeout(() => {
          closeModal();
        }, 2000);
      }
    };

    window.closeModal = () => {
      modal.classList.remove('active');
    };

    // Forgot password modal
    window.openForgotModal = (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      document.getElementById('forgot-email').value = email;
      forgotModal.classList.add('active');
    };

    window.closeForgotModal = () => {
      forgotModal.classList.remove('active');
    };

    // Set loading state
    function setLoading(isLoading) {
      const btn = document.getElementById('submit-btn');
      const btnText = document.getElementById('btn-text');
      const btnLoading = document.getElementById('btn-loading');
      
      if (isLoading) {
        btn.disabled = true;
        btnText.style.display = 'none';
        btnLoading.style.display = 'inline-block';
      } else {
        btn.disabled = false;
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
      }
    };

    // Set Google button loading state
    function setGoogleLoading(isLoading) {
      if (isLoading) {
        googleBtn.disabled = true;
        googleBtn.classList.add('loading');
        googleBtnText.style.display = 'none';
        googleBtnLoading.style.display = 'inline-block';
      } else {
        googleBtn.disabled = false;
        googleBtn.classList.remove('loading');
        googleBtnText.style.display = 'inline';
        googleBtnLoading.style.display = 'none';
      }
    };

    // Generate random password
    function generateRandomPassword(length = 12) {
      const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{}|;:,.<>?";
      let password = "";
      for (let i = 0; i < length; i++) {
        password += charset.charAt(Math.floor(Math.random() * charset.length));
      }
      return password;
    }

    // Check if user exists by email (both auth and database)
    async function checkUserByEmail(email) {
      try {
        // Cek di Firebase Auth
        const userByEmail = await auth.fetchSignInMethodsForEmail(email);
        
        // Cek di database
        const usersRef = ref(database, 'users');
        const snapshot = await get(usersRef);
        let userInDB = null;
        
        if (snapshot.exists()) {
          snapshot.forEach(childSnapshot => {
            const userData = childSnapshot.val();
            if (userData.email === email) {
              userInDB = userData;
            }
          });
        }
        
        return {
          existsInAuth: userByEmail.length > 0,
          existsInDB: userInDB !== null,
          userInDB: userInDB
        };
      } catch (error) {
        console.error('Error checking user by email:', error);
        return { existsInAuth: false, existsInDB: false, userInDB: null };
      }
    }

    // Link Google account to existing email account
    async function linkGoogleToEmail(googleUser, email) {
      try {
        // Cari akun email yang ada
        const emailUser = await auth.signInWithEmailAndPassword(auth, email, 'temporary-password');
        
        if (emailUser.user) {
          // Link Google account to email account
          const credential = GoogleAuthProvider.credentialFromResult(googleUser);
          await emailUser.user.linkWithCredential(credential);
          
          // Update data di database
          const userRef = ref(database, 'users/' + emailUser.user.uid);
          await set(userRef, {
            ...emailUser.user,
            googleUid: googleUser.user.uid,
            accountType: 'linked',
            linkedAt: new Date().toISOString()
          });
          
          return true;
        }
      } catch (error) {
        console.error('Error linking accounts:', error);
        return false;
      }
    }

    // Check if user exists in verified database
    async function checkUserVerified(uid) {
      try {
        const userRef = ref(database, 'users/' + uid);
        const snapshot = await get(userRef);
        return snapshot.exists();
      } catch (error) {
        console.error('Database error:', error);
        return false;
      }
    };

    // Auto create user data for Google login
    async function createGoogleUserData(user) {
      try {
        const userRef = ref(database, 'users/' + user.uid);
        
        const userData = {
          uid: user.uid,
          fullname: user.displayName || 'User',
          email: user.email,
          emailVerified: true,
          verifiedAt: new Date().toISOString(),
          createdAt: new Date().toISOString(),
          accountType: 'google',
          lastLogin: new Date().toISOString()
        };

        await set(userRef, userData);
        console.log('Google user data created:', userData);
        return true;
      } catch (error) {
        console.error('Error creating Google user data:', error);
        return false;
      }
    };

    // Show Google Results Popup
    function showGoogleResults(user) {
      // Tampilkan overlay
      overlay.classList.add('active');
      
      // Tampilkan popup hasil
      googleResultsPopup.classList.add('active');
      
      // Isi konten popup dengan informasi user
      const resultsHTML = `
        <ul class="google-results-links">
          <li>
            <a href="#" onclick="event.preventDefault(); showUserDetails('${user.uid}');">
              <i class="fas fa-user"></i>
              Profil Pengguna
              <div class="url">${user.email}</div>
              <div class="description">Informasi akun dan preferensi pengguna</div>
              <div class="tags">
                <span class="tag google">Google</span>
                <span class="tag email">Email Verifikasi</span>
                <span class="tag verified">Verified</span>
              </div>
            </a>
          </li>
          <li>
            <a href="#" onclick="event.preventDefault(); showSecuritySettings('${user.uid}');">
              <i class="fas fa-shield-alt"></i>
              Pengaturan Keamanan
              <div class="url">Security Settings</div>
              <div class="description">Kelola kata sandi, autentikasi dua faktor, dan keamanan akun</div>
              <div class="tags">
                <span class="tag google">Google</span>
                <span class="tag security">Keamanan</span>
              </div>
            </a>
          </li>
          <li>
            <a href="#" onclick="event.preventDefault(); showPrivacySettings('${user.uid}');">
              <i class="fas fa-lock"></i>
              Privasi Akun
              <div class="url">Privacy Settings</div>
              <div class="description">Kontrol data pribadi dan preferensi privasi</div>
              <div class="tags">
                <span class="tag google">Google</span>
                <span class="tag privacy">Privasi</span>
              </div>
            </a>
          </li>
          <li>
            <a href="#" onclick="event.preventDefault(); showConnectedApps('${user.uid}');">
              <i class="fas fa-link"></i>
              Aplikasi Terhubung
              <div class="url">Connected Apps</div>
              <div class="description">Aplikasi yang memiliki akses ke akun Google Anda</div>
              <div class="tags">
                <span class="tag google">Google</span>
                <span class="tag apps">Aplikasi</span>
              </div>
            </a>
          </li>
          <li>
            <a href="#" onclick="event.preventDefault(); showActivityLog('${user.uid}');">
              <i class="fas fa-history"></i>
              Log Aktivitas
              <div class="url">Activity Log</div>
              <div class="description">Riwayat aktivitas akun dan login</div>
              <div class="tags">
                <span class="tag google">Google</span>
                <span class="tag history">Log</span>
              </div>
            </a>
          </li>
        </ul>
      `;
      
      googleResultsContent.innerHTML = resultsHTML;
    };

    // Close Google Results Popup
    window.closeGoogleResults = () => {
      googleResultsPopup.classList.remove('active');
      overlay.classList.remove('active');
    };

    // Handle User Details
    function showUserDetails(uid) {
      const detailsHTML = `
        <h3>Detail Pengguna</h3>
        <p>Mengambil informasi detail untuk ${uid}...</p>
        <button class="modal-btn" onclick="closeGoogleResults()">Tutup</button>
      `;
      googleResultsContent.innerHTML = detailsHTML;
    };

    // Handle Security Settings
    function showSecuritySettings(uid) {
      const securityHTML = `
        <h3>Pengaturan Keamanan</h3>
        <p>Mengakses pengaturan keamanan untuk ${uid}...</p>
        <button class="modal-btn" onclick="closeGoogleResults()">Tutup</button>
      `;
      googleResultsContent.innerHTML = securityHTML;
    };

    // Handle Privacy Settings
    function showPrivacySettings(uid) {
      const privacyHTML = `
        <h3>Pengaturan Privasi</h3>
        <p>Mengakses pengaturan privasi untuk ${uid}...</p>
        <button class="modal-btn" onclick="closeGoogleResults()">Tutup</button>
      `;
      googleResultsContent.innerHTML = privacyHTML;
    };

    // Handle Connected Apps
    function showConnectedApps(uid) {
      const appsHTML = `
        <h3>Aplikasi Terhubung</h3>
        <p>Memeriksa aplikasi yang terhubung ke ${uid}...</p>
        <button class="modal-btn" onclick="closeGoogleResults()">Tutup</button>
      `;
      googleResultsContent.innerHTML = appsHTML;
    };

    // Handle Activity Log
    function showActivityLog(uid) {
      const logHTML = `
        <h3>Log Aktivitas</h3>
        <p>Memuat riwayat aktivitas untuk ${uid}...</p>
        <button class="modal-btn" onclick="closeGoogleResults()">Tutup</button>
      `;
      googleResultsContent.innerHTML = logHTML;
    };

    // Redirect to dashboard
    function redirectToDashboard() {
      showRedirectIndicator();
      setTimeout(() => {
        window.location.href = 'dashboard.html';
      }, 1000);
    };

    // Handle password reset
    window.handlePasswordReset = async () => {
      const email = document.getElementById('forgot-email').value.trim();
      
      if (!email) {
        showModal('error', 'Email kosong', 'Masukkan email Anda');
        return;
      }
      
      try {
        await sendPasswordResetEmail(auth, email);
        showModal('success', 'Email terkirim', `Link reset password telah dikirim ke ${email}`);
        closeForgotModal();
      } catch (error) {
        showModal('error', 'Gagal', errors[error.code] || errors.default);
      }
    };

    // Handle email login
    async function handleEmailLogin(email, password, remember) {
      try {
        // Set persistence
        if (remember) {
          await setPersistence(auth, browserLocalPersistence);
        } else {
          await setPersistence(auth, browserSessionPersistence);
        }
        
        // Sign in
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        // Check if email is verified
        if (!user.emailVerified) {
          await auth.signOut();
          showModal('error', 'Verifikasi email', 'Verifikasi email Anda sebelum login', false);
          return false;
        }
        
        // Check if user is in verified database
        const isVerifiedInDB = await checkUserVerified(user.uid);
        
        if (!isVerifiedInDB) {
          // Auto create user data if not exists
          await createGoogleUserData(user);
        }
        
        return true;
            
      } catch (error) {
        const message = errors[error.code] || errors.default;
        showModal('error', 'Login gagal', message, false);
        return false;
      }
    }

    // Handle Google Sign In - MENGGUNAKAN POPUP DENGAN FALLBACK KE IFRAME
    async function handleGoogleSignIn() {
      setGoogleLoading(true);
      try {
        // Coba gunakan popup terlebih dahulu
        const result = await signInWithPopup(auth, provider);
        const googleUser = result.user;
        
        // Cek apakah email sudah ada di sistem
        const emailCheck = await checkUserByEmail(googleUser.email);
        
        if (emailCheck.existsInAuth && emailCheck.existsInDB) {
          // Email sudah ada, coba link akun
          const linked = await linkGoogleToEmail(result, googleUser.email);
          
          if (linked) {
            showModal('success', 'Akun Terhubung', 'Akun Google Anda berhasil terhubung dengan akun email yang ada');
            // Tampilkan popup hasil login Google
            showGoogleResults(googleUser);
            setGoogleLoading(false);
            return;
          }
        }
        
        // Tampilkan popup hasil login Google
        showGoogleResults(googleUser);
        
        // Auto create user data if not exists
        const isVerified = await checkUserVerified(googleUser.uid);
        if (!isVerified) {
          await createGoogleUserData(googleUser);
        }
        
        // Tidak redirect ke dashboard, tetap di popup
        setGoogleLoading(false);

      } catch (error) {
        console.error("Google Sign-In Error:", error);
        
        // Tangani kasus popup diblokir atau ditutup
        if (error.code === 'auth/popup-blocked') {
          showModal('info', 'Perlu Izin Popup', 'Popup diblokir oleh browser. Silakan ikuti instruksi yang muncul.', false);
          showPopupInstructions(); // Tampilkan instruksi
        } else if (error.code === 'auth/popup-closed-by-user') {
          showModal('error', 'Login Dibatalkan', 'Anda menutup jendela login sebelum selesai. Silakan coba lagi.', false);
        } else {
          // Untuk error lainnya, tampilkan pesan error
          const message = errors[error.code] || errors.default;
          showModal('error', 'Login Google Gagal', message, false);
        }
        
        setGoogleLoading(false);
      }
    };

    // Google Sign In button click
    googleBtn.addEventListener('click', handleGoogleSignIn);

    // Handle form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const remember = document.getElementById('remember').checked;
      
      if (!email) {
        showModal('error', 'Email kosong', 'Harap masukkan email Anda');
        return;
      }
      
      setLoading(true);
      
      try {
        // Cek apakah email ada di sistem
        const emailCheck = await checkUserByEmail(email);
        
        let finalPassword = password;
        
        if (!password) {
          // Jika password kosong, generate password random
          finalPassword = generateRandomPassword();
          showModal('info', 'Password Generated', `Sistem telah menghasilkan password acak: <strong>${finalPassword}</strong><br>Silakan simpan password ini untuk login berikutnya.`, false);
        }
        
        // Coba login dengan password yang ada atau yang di-generate
        const loginSuccess = await handleEmailLogin(email, finalPassword, remember);
        
        if (loginSuccess) {
          redirectToDashboard();
        }
        
      } catch (error) {
        const message = errors[error.code] || errors.default;
        showModal('error', 'Login gagal', message, false);
      } finally {
        setLoading(false);
      }
    });

    // Check if user is already logged in or returning from a redirect
    function checkCurrentAuth() {
      // Pertama, cek apakah kita sedang kembali dari redirect sign-in
      getRedirectResult(auth)
        .then(async (result) => {
          if (result) {
            // User baru saja sign in via redirect
            const user = result.user;
            const isVerified = await checkUserVerified(user.uid);
            if (!isVerified) {
              await createGoogleUserData(user);
            }
            redirectToDashboard();
            return; // Hentikan eksekusi lebih lanjut
          }

          // Jika tidak ada hasil redirect, cek status auth saat ini
          onAuthStateChanged(auth, async (user) => {
            if (user) {
              if (user.emailVerified) {
                const isVerified = await checkUserVerified(user.uid);
                if (isVerified) {
                  redirectToDashboard();
                  return;
                }
              }
            }
            
            // Jika tidak login, tampilkan form login
            loadingScreen.style.display = 'none';
            loginContainer.style.display = 'block';
          });
        })
        .catch((error) => {
          // Tangani error dari getRedirectResult, misalnya user membatalkan sign-in
          console.error("Redirect Result Error:", error);
          loadingScreen.style.display = 'none';
          loginContainer.style.display = 'block';
        });
    };

    // Initialize
    window.addEventListener('load', () => {
      checkCurrentAuth();
    });

    // Enter key support
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && document.activeElement.id === 'forgot-email') {
        handlePasswordReset();
      }
    });
  </script>
</body>
</html>
